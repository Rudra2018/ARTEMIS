{% extends "base.html" %}

{% block title %}Run Tests - AI Testing Suite{% endblock %}

{% block content %}
<div class="row animate-in">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-play me-2"></i>
                    Configure and Run Tests
                </h4>
            </div>
            <div class="card-body">
                <form id="testForm">
                    <!-- Test Suite Selection -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>
                                <i class="fas fa-list me-2"></i>
                                Select Test Suite
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card test-suite-card" data-suite="all">
                                        <div class="card-body text-center">
                                            <i class="fas fa-globe fa-2x text-primary mb-3"></i>
                                            <h6>All Tests</h6>
                                            <small class="text-muted">Complete test suite including core, API, security, and performance tests</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card test-suite-card" data-suite="core">
                                        <div class="card-body text-center">
                                            <i class="fas fa-brain fa-2x text-info mb-3"></i>
                                            <h6>Core LLM Tests</h6>
                                            <small class="text-muted">Basic conversation, context, multilingual, and instruction following</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card test-suite-card" data-suite="api">
                                        <div class="card-body text-center">
                                            <i class="fas fa-cloud fa-2x text-success mb-3"></i>
                                            <h6>API Integration</h6>
                                            <small class="text-muted">Test integration with OpenAI, Claude, Google AI Studio, etc.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card test-suite-card" data-suite="security">
                                        <div class="card-body text-center">
                                            <i class="fas fa-shield-alt fa-2x text-warning mb-3"></i>
                                            <h6>Advanced Security Tests</h6>
                                            <small class="text-muted">SEI & OpenAI, WDTA L1-L4, CyberSecEval 2, Purple Llama, Garak, OWASP LLM Top 10</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card test-suite-card" data-suite="performance">
                                        <div class="card-body text-center">
                                            <i class="fas fa-tachometer-alt fa-2x text-danger mb-3"></i>
                                            <h6>Performance Tests</h6>
                                            <small class="text-muted">Response time, throughput, scalability testing</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card test-suite-card" data-suite="ml">
                                        <div class="card-body text-center">
                                            <i class="fas fa-chart-line fa-2x text-purple mb-3"></i>
                                            <h6>ML Model Tests</h6>
                                            <small class="text-muted">Accuracy, bias detection, hallucination testing</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="selectedSuite" name="suite_type" required>
                        </div>
                    </div>

                    <!-- Provider Selection -->
                    <div class="row mb-4" id="providerSelection" style="display: none;">
                        <div class="col-12">
                            <h5>
                                <i class="fas fa-plug me-2"></i>
                                Select AI Providers
                            </h5>
                            <div class="row" id="providerCards">
                                <!-- Provider cards will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Test Configuration -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>
                                <i class="fas fa-cog me-2"></i>
                                Test Configuration
                            </h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Execution Mode</h6>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="execution_mode" 
                                               id="mockMode" value="mock" checked>
                                        <label class="form-check-label" for="mockMode">
                                            <i class="fas fa-flask me-2"></i>
                                            <strong>Mock Mode (Recommended)</strong>
                                            <br>
                                            <small class="text-muted">Use mock responses for testing without API costs</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="execution_mode" 
                                               id="liveMode" value="live">
                                        <label class="form-check-label" for="liveMode">
                                            <i class="fas fa-globe me-2"></i>
                                            <strong>Live Mode</strong>
                                            <br>
                                            <small class="text-muted">Test against real APIs (requires API keys)</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Advanced Options</h6>
                                    <div class="mb-3">
                                        <label for="timeout" class="form-label">Test Timeout (seconds)</label>
                                        <input type="number" class="form-control" id="timeout" name="timeout" 
                                               value="300" min="60" max="1800">
                                    </div>
                                    <div class="mb-3">
                                        <label for="maxRetries" class="form-label">Max Retries</label>
                                        <input type="number" class="form-control" id="maxRetries" name="max_retries" 
                                               value="3" min="1" max="10">
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="generateReports" 
                                               name="generate_reports" checked>
                                        <label class="form-check-label" for="generateReports">
                                            Generate detailed reports
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary btn-lg me-3" id="runTestBtn">
                                <i class="fas fa-play me-2"></i>
                                Run Tests
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                                <i class="fas fa-refresh me-2"></i>
                                Reset Form
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Test Execution Modal -->
<div class="modal fade" id="testExecutionModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play me-2"></i>
                    Test Execution in Progress
                </h5>
            </div>
            <div class="modal-body">
                <!-- Test Info -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Test ID:</strong> <code id="modalTestId"></code>
                            </div>
                            <div class="col-md-6">
                                <strong>Suite:</strong> <span id="modalTestSuite"></span>
                            </div>
                            <div class="col-md-6 mt-2">
                                <strong>Started:</strong> <span id="modalStartTime"></span>
                            </div>
                            <div class="col-md-6 mt-2">
                                <strong>Mode:</strong> <span id="modalExecutionMode"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Progress</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="modalProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="alert alert-info" id="currentStatus">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="statusMessage">Initializing test execution...</span>
                </div>

                <!-- Live Log -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-terminal me-2"></i>
                            Live Log
                            <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">
                                <i class="fas fa-trash me-1"></i>Clear
                            </button>
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="liveLog" class="test-log p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-muted">Waiting for test to start...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="cancelTestBtn">
                    <i class="fas fa-stop me-2"></i>
                    Cancel Test
                </button>
                <button type="button" class="btn btn-primary" id="viewResultsBtn" style="display: none;" 
                        onclick="viewTestResults()">
                    <i class="fas fa-eye me-2"></i>
                    View Results
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalBtn">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.test-suite-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.test-suite-card:hover {
    border-color: #007bff;
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,123,255,0.15);
}

.test-suite-card.selected {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.provider-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.provider-card:hover {
    border-color: #28a745;
    transform: translateY(-2px);
}

.provider-card.selected {
    border-color: #28a745;
    background-color: #f8fff8;
}

.provider-card.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.text-purple {
    color: #6f42c1 !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let selectedSuite = null;
let selectedProviders = [];
let currentTestId = null;
let executionModal = null;
let availableProviders = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modal
    executionModal = new bootstrap.Modal(document.getElementById('testExecutionModal'));
    
    // Load providers
    loadProviders();
    
    // Setup event listeners
    setupEventListeners();
    
    // Setup socket listeners
    setupSocketListeners();
});

function loadProviders() {
    fetch('/api/providers')
        .then(response => response.json())
        .then(providers => {
            availableProviders = providers;
            renderProviderCards();
        })
        .catch(error => {
            console.error('Failed to load providers:', error);
            showToast('Failed to load provider information', 'warning');
        });
}

function renderProviderCards() {
    const container = document.getElementById('providerCards');
    container.innerHTML = '';
    
    availableProviders.forEach(provider => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        
        const cardClass = provider.configured ? 'provider-card' : 'provider-card disabled';
        const iconColor = provider.configured ? 'text-success' : 'text-muted';
        
        col.innerHTML = `
            <div class="card ${cardClass}" data-provider="${provider.name}">
                <div class="card-body text-center">
                    <i class="fas fa-plug fa-2x ${iconColor} mb-2"></i>
                    <h6>${provider.display_name}</h6>
                    <small class="text-muted">
                        ${provider.configured ? 
                            `${provider.model} (${provider.rate_limit} RPM)` : 
                            'Not configured'
                        }
                    </small>
                    ${provider.configured ? 
                        '<i class="fas fa-check-circle text-success mt-2"></i>' : 
                        '<i class="fas fa-times-circle text-danger mt-2"></i>'
                    }
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
}

function setupEventListeners() {
    // Test suite selection
    document.querySelectorAll('.test-suite-card').forEach(card => {
        card.addEventListener('click', function() {
            // Remove previous selection
            document.querySelectorAll('.test-suite-card').forEach(c => c.classList.remove('selected'));
            
            // Add selection to clicked card
            this.classList.add('selected');
            selectedSuite = this.dataset.suite;
            document.getElementById('selectedSuite').value = selectedSuite;
            
            // Show/hide provider selection based on suite
            const providerSelection = document.getElementById('providerSelection');
            if (selectedSuite === 'api' || selectedSuite === 'all') {
                providerSelection.style.display = 'block';
            } else {
                providerSelection.style.display = 'none';
                selectedProviders = [];
            }
        });
    });
    
    // Provider selection (event delegation)
    document.getElementById('providerCards').addEventListener('click', function(e) {
        const card = e.target.closest('.provider-card');
        if (!card || card.classList.contains('disabled')) return;
        
        const provider = card.dataset.provider;
        
        if (card.classList.contains('selected')) {
            // Deselect
            card.classList.remove('selected');
            selectedProviders = selectedProviders.filter(p => p !== provider);
        } else {
            // Select
            card.classList.add('selected');
            selectedProviders.push(provider);
        }
    });
    
    // Form submission
    document.getElementById('testForm').addEventListener('submit', function(e) {
        e.preventDefault();
        startTest();
    });
    
    // Cancel test
    document.getElementById('cancelTestBtn').addEventListener('click', function() {
        if (currentTestId) {
            cancelTest(currentTestId);
        }
    });
}

function startTest() {
    if (!selectedSuite) {
        showToast('Please select a test suite', 'warning');
        return;
    }
    
    // Collect form data
    const formData = new FormData(document.getElementById('testForm'));
    const testConfig = {
        suite_type: selectedSuite,
        providers: selectedProviders,
        live_mode: formData.get('execution_mode') === 'live',
        mock_responses: formData.get('execution_mode') === 'mock',
        timeout: parseInt(formData.get('timeout')),
        max_retries: parseInt(formData.get('max_retries')),
        generate_reports: formData.get('generate_reports') === 'on'
    };
    
    // Disable form and show loading
    document.getElementById('runTestBtn').disabled = true;
    document.getElementById('runTestBtn').innerHTML = 
        '<i class="fas fa-spinner fa-spin me-2"></i>Starting Test...';
    
    // Start test
    fetch('/api/test/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(testConfig)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentTestId = data.test_id;
        
        // Update modal with test info
        document.getElementById('modalTestId').textContent = currentTestId;
        document.getElementById('modalTestSuite').textContent = selectedSuite.toUpperCase();
        document.getElementById('modalStartTime').textContent = new Date().toLocaleString();
        document.getElementById('modalExecutionMode').textContent = testConfig.live_mode ? 'Live' : 'Mock';
        
        // Show modal
        executionModal.show();
        
        // Join test room for real-time updates
        socket.emit('join_test', { test_id: currentTestId });
        
        showToast('Test started successfully!', 'success');
    })
    .catch(error => {
        console.error('Error starting test:', error);
        showToast('Failed to start test: ' + error.message, 'danger');
    })
    .finally(() => {
        // Re-enable form
        document.getElementById('runTestBtn').disabled = false;
        document.getElementById('runTestBtn').innerHTML = 
            '<i class="fas fa-play me-2"></i>Run Tests';
    });
}

function cancelTest(testId) {
    fetch(`/api/test/cancel/${testId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            showToast('Test cancelled successfully', 'warning');
            updateStatus('Test cancelled by user', 'warning');
        })
        .catch(error => {
            console.error('Error cancelling test:', error);
            showToast('Failed to cancel test', 'danger');
        });
}

function setupSocketListeners() {
    socket.on('test_progress_update', function(data) {
        if (data.test_id === currentTestId) {
            updateProgress(data.progress, data.message);
            addLogEntry(data.message, 'info');
        }
    });
    
    socket.on('test_completed', function(data) {
        if (data.test_id === currentTestId) {
            updateProgress(100, 'Test completed successfully!');
            updateStatus('Test completed successfully!', 'success');
            addLogEntry('Test execution completed', 'success');
            
            // Show results button
            document.getElementById('viewResultsBtn').style.display = 'inline-block';
            document.getElementById('cancelTestBtn').style.display = 'none';
            
            showToast('Test completed successfully!', 'success');
        }
    });
    
    socket.on('test_failed', function(data) {
        if (data.test_id === currentTestId) {
            updateStatus('Test failed: ' + data.error, 'danger');
            addLogEntry('Test execution failed: ' + data.error, 'error');
            
            document.getElementById('cancelTestBtn').style.display = 'none';
            
            showToast('Test execution failed', 'danger');
        }
    });
}

function updateProgress(percentage, message) {
    const progressBar = document.getElementById('modalProgressBar');
    const progressText = document.getElementById('progressPercentage');
    
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
    progressText.textContent = percentage + '%';
    
    if (percentage >= 100) {
        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        progressBar.classList.add('bg-success');
    }
    
    if (message) {
        document.getElementById('statusMessage').textContent = message;
    }
}

function updateStatus(message, type = 'info') {
    const statusDiv = document.getElementById('currentStatus');
    const iconMap = {
        'info': 'fa-info-circle',
        'success': 'fa-check-circle',
        'warning': 'fa-exclamation-triangle',
        'danger': 'fa-times-circle',
        'error': 'fa-times-circle'
    };
    
    statusDiv.className = `alert alert-${type}`;
    statusDiv.innerHTML = `
        <i class="fas ${iconMap[type] || 'fa-info-circle'} me-2"></i>
        <span id="statusMessage">${message}</span>
    `;
}

function addLogEntry(message, type = 'info') {
    const logContainer = document.getElementById('liveLog');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    
    const colorMap = {
        'info': '#00bcd4',
        'success': '#4caf50',
        'warning': '#ff9800',
        'error': '#f44336'
    };
    
    logEntry.innerHTML = `
        <span style="color: #888;">[${timestamp}]</span> 
        <span style="color: ${colorMap[type] || '#fff'};">${message}</span>
    `;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function clearLog() {
    document.getElementById('liveLog').innerHTML = '';
}

function viewTestResults() {
    if (currentTestId) {
        window.open(`/results/${currentTestId}`, '_blank');
    }
}

function resetForm() {
    // Clear selections
    document.querySelectorAll('.test-suite-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('.provider-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Reset variables
    selectedSuite = null;
    selectedProviders = [];
    
    // Reset form
    document.getElementById('testForm').reset();
    document.getElementById('selectedSuite').value = '';
    document.getElementById('providerSelection').style.display = 'none';
    
    // Reset radio buttons
    document.getElementById('mockMode').checked = true;
}
</script>
{% endblock %}